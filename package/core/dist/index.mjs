import E from 'axios';
import G from 'ws';
import { unzip } from 'node:zlib';
import { promisify } from 'node:util';
import { dirname } from 'node:path';
import { fileURLToPath } from 'node:url';
import X from 'path';
import N from 'protobufjs';

var F=Object.defineProperty;var q=(o,e)=>{for(var a in e)F(o,a,{get:e[a],enumerable:!0});};var ee=async o=>{let e=`https://live.douyin.com/${o}`,a={accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36",cookie:"__ac_nonce=0638733a400869171be51"},i=await E.get(e,{headers:a}),n=[...i.headers["set-cookie"][0].matchAll(/ttwid=(.+?);/g)][0][1],l=[...i.data.matchAll(/script id=\"RENDER_DATA\" type=\"application\/json\"\>(.*?)\<\/script\>/g)][0][1],p=JSON.parse(decodeURIComponent(l)),m=p.app.initialState.roomStore,g=m.roomInfo.roomId,M=m.roomInfo.room.title;return {fulldata:p,ttwid:n,liveRoomId:g,liveRoomTitle:M}};var ae=async(o,e)=>{let{liveRoomId:a,ttwid:i}=o,c=`wss://webcast3-ws-web-hl.douyin.com/webcast/im/push/v2/?app_name=douyin_web&version_code=180800&webcast_sdk_version=1.3.0&update_version_code=1.3.0&compress=gzip&internal_ext=internal_src:dim|wss_push_room_id:${a}|wss_push_did:${a}|dim_log_id:2022122306295965382308B5DCD45D07F8|fetch_time:1671748199438|seq:1|wss_info:0-1671748199438-0-0|wrds_kvs:WebcastRoomRankMessage-1671748147622091132_WebcastRoomStatsMessage-1671748195537766499&cursor=t-1671748199438_r-1_d-1_u-1_h-1&host=https://live.douyin.com&aid=6383&live_id=1&did_rule=3&debug=false&endpoint=live_pc&support_wrds=1&im_path=/webcast/im/fetch/&device_platform=web&cookie_enabled=true&screen_width=1440&screen_height=900&browser_language=zh&browser_platform=MacIntel&browser_name=Mozilla&browser_version=5.0%20(Macintosh;%20Intel%20Mac%20OS%20X%2010_15_7)%20AppleWebKit/537.36%20(KHTML,%20like%20Gecko)%20Chrome/108.0.0.0%20Safari/537.36&browser_online=true&tz_name=Asia/Shanghai&identity=audience&room_id=${a}&heartbeatDuration=0`,n=new G(c,{headers:{cookie:`ttwid=${i}`,"user-agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36"}});return e&&(n.onopen=e?.onopen,n.onerror=e?.onerror,n.onclose=e?.onclose,n.onmessage=e?.onmessage),n};var s={};q(s,{doUnzip:()=>O,getCurrentPath:()=>f,stringToUint8:()=>$,unPackData:()=>j});var $=o=>new TextEncoder().encode(o),O=promisify(unzip),f=o=>{let e=fileURLToPath(o);return {__dirname__:dirname(e),__filename__:e}};function j(o,e){return e.decode(o)}var {__dirname__:J}=f(import.meta.url),Q=X.resolve(J,"dy.proto"),r=await N.load(Q),u=r.lookupType("douyin.PushFrame"),_=r.lookupType("douyin.Response"),b=r.lookupType("douyin.ChatMessage"),h=r.lookupType("douyin.CommonTextMessage"),y=r.lookupType("douyin.RoomUserSeqMessage"),D=r.lookupType("douyin.SocialMessage"),x=r.lookupType("douyin.MatchAgainstScoreMessage"),S=r.lookupType("douyin.MemberMessage"),T=r.lookupType("douyin.GiftMessage"),w=r.lookupType("douyin.LikeMessage"),v=r.lookupType("douyin.UpdateFanTicketMessage");async function fe(o,e,{handleChatMessage:a,handleCommonTextMessage:i,handleGiftMessage:c,handleLikeMessage:n,handleMatchAgainstScoreMessage:l,handleMemberMessage:p,handleRoomUserSeqMessage:m,handleSocialMessage:g,handleUpdateFanTicketMessage:M,handleUnknowMessage:k}){let Y=o.data,R=u.decode(new Uint8Array(Y)),{logId:U,payload:W}=R,C=await s.doUnzip(Buffer.from(W)),P=_.decode(Buffer.from(C)),{messagesList:A,needAck:L,internalExt:I}=P;if(L){let d=u.create({logId:U,payload:I});e.send(u.encode(d).finish());}for(let d of A)try{let t=Buffer.from(d.payload,"base64");switch(d.method){case"WebcastChatMessage":a&&a(s.unPackData(t,b));break;case"WebcastMatchAgainstScoreMessage":l&&l(s.unPackData(t,x));break;case"WebcastLikeMessage":n&&n(s.unPackData(t,w));break;case"WebcastMemberMessage":p&&p(s.unPackData(t,S));break;case"WebcastGiftMessage":c&&c(s.unPackData(t,T));break;case"WebcastSocialMessage":g&&g(s.unPackData(t,D));break;case"WebcastRoomUserSeqMessage":m&&m(s.unPackData(t,y));break;case"WebcastUpdateFanTicketMessage":M&&M(s.unPackData(t,v));break;case"WebcastCommonTextMessage":i&&i(s.unPackData(t,h));break;default:k&&k(d.method,t);break}}catch{}}

export { b as ChatMessage, h as CommonTextMessage, T as GiftMessage, w as LikeMessage, x as MatchAgainstScoreMessage, S as MemberMessage, u as PushFrame, _ as Response, y as RoomUserSeqMessage, D as SocialMessage, v as UpdateFanTicketMessage, fe as incoming, ae as initWsConnect, ee as parseLiveUrl, r as root };
